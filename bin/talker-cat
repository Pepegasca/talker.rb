#!/usr/bin/env ruby
require "talker"
require "talker/cli"

token = Talker::CLI.load_token
room = ARGV.first

abort <<-EOS unless room
usage: echo 'something' | talker-cat <room_id>

  Send a message to a room:
  
    echo 'something' | talker-cat 1
  
  Send a file to a room:
  
    talker-cat 1 < site_fixer.rb
  
  Room ID is the last part of the URL:
    https://myaccount.talkerapp.com/rooms/<room_id>
  
EOS

# Non-blocking reader for stdin
module Reader
  attr_accessor :client
  
  def notify_readable
    @client.send_message @io.readline.chomp
  rescue EOFError
    detach
  end
  
  def unbind
    @client.close
  end
end

Talker.connect(:room => room.to_i, :token => token) do |client|
  client.on_connected do
    conn = EM.watch STDIN, Reader
    conn.client = client
    conn.notify_readable = true
  end
  client.on_error do |error|
    puts error
  end
  trap("INT") { client.close }
end
